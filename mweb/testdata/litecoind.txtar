# Start litecoind
exec mkdir $WORK/litecoin
exec litecoind -datadir=$WORK/litecoin -regtest -port=$P2P_PORT &
litecoin-cli -rpcwait -rpcwaittimeout=5 createwallet test

# Start lnd
exec lnd &
openRpcConn $WORK/lnd 0
createWallet
openRpcConn $WORK/lnd 1

# Generate pre-MWEB blocks
generate 431

# Send pegin transaction
litecoin-cli getnewaddress '' mweb
getResult LITECOIND_MWEB_ADDR_1
litecoin-cli sendtoaddress $LITECOIND_MWEB_ADDR_1 1
generate 1

# Send to lnd
newAddress mweb
getResult LND_MWEB_ADDR_1
litecoin-cli sendtoaddress $LND_MWEB_ADDR_1 100
generate 1

# Verify that lnd received coins
waitForUtxos 1
checkUtxo 0 $LND_MWEB_ADDR_1 100
checkTxnHistory 0 '' 100 0 $LND_MWEB_ADDR_1

# Send mweb within lnd wallet
newAddress mweb
getResult LND_MWEB_ADDR_2
sendCoins $LND_MWEB_ADDR_2 50
getResult TXID
generate 1
waitForUtxos 2
checkUtxo 0 $LND_MWEB_ADDR_1 49.999961
checkUtxo 1 $LND_MWEB_ADDR_2 50
checkTxnHistory 0 $TXID -0.000039 0.000039 $LND_MWEB_ADDR_1,$LND_MWEB_ADDR_2

# Send pegout within lnd wallet
newAddress p2wkh
getResult LND_P2WKH_ADDR_1
sendCoins $LND_P2WKH_ADDR_1 50
getResult TXID
checkTxnHistory 0 $TXID -50.000084 0.000084 $LND_P2WKH_ADDR_1,$LND_MWEB_ADDR_2
generate 1
waitForUtxos 1
checkUtxo 0 $LND_MWEB_ADDR_2 49.999877
checkTxnHistory 0 '' 50 0 $LND_P2WKH_ADDR_1
checkTxnHistory 1 $TXID -50.000084 0.000084 $LND_P2WKH_ADDR_1,$LND_MWEB_ADDR_2
generate 4
waitForUtxos 1
generate 1
waitForUtxos 2
checkUtxo 0 $LND_MWEB_ADDR_2 49.999877
checkUtxo 1 $LND_P2WKH_ADDR_1 50

# Send pegin within lnd wallet
newAddress mweb
getResult LND_MWEB_ADDR_3
sendCoins $LND_MWEB_ADDR_3 50
getResult TXID
generate 1
waitForUtxos 2
checkUtxo 0 $LND_MWEB_ADDR_3 49.99953
checkUtxo 1 $LND_MWEB_ADDR_3 50
checkTxnHistory 0 $TXID -0.000347 0.000347 $LND_MWEB_ADDR_3,$LND_MWEB_ADDR_3

# Send mweb to litecoind
newAddress mweb
getResult LND_MWEB_ADDR_4
litecoin-cli getnewaddress '' mweb
getResult LITECOIND_MWEB_ADDR_2
sendCoins $LITECOIND_MWEB_ADDR_2 50
getResult TXID
checkTxnHistory 0 $TXID -50.000039 0.000039 $LITECOIND_MWEB_ADDR_2,$LND_MWEB_ADDR_4
waitForUtxos 1
checkUtxo 0 $LND_MWEB_ADDR_4 49.999491
generate 1
litecoin-cli listunspent 1 1
getResult RESULT
checkResult $TXID RESULT 0 txid
checkResult 50 RESULT 0 amount
checkResult $LITECOIND_MWEB_ADDR_2 RESULT 0 address
